#!/usr/bin/perl6




use v6;




# -----------------------------------------------------------------------------
# main
# -----------------------------------------------------------------------------

# release
multi sub MAIN(
    Str $file,
    Str :N(:$pkgname),
    Str :V(:$pkgver),
    Int :R(:$pkgrel),
    Str :D(:$pkgdesc),
    Str :I(:$txndir),
    Int :L(:$date-local-offset),
    Str :T(:$template)
)
{
    my %opts;
    %opts<pkgname> = $pkgname if $pkgname;
    %opts<pkgver> = $pkgver if $pkgver;
    %opts<pkgrel> = $pkgrel if $pkgrel;
    %opts<pkgdesc> = $pkgdesc if $pkgdesc;
    %opts<txndir> = ~$txndir.IO.resolve if $txndir;
    %opts<date-local-offset> = Int($date-local-offset) if $date-local-offset;
    %opts<template> = $template if $template;

    use TXN;
    mktxn(:$file, :release, |%opts);
}

# serialize
multi sub MAIN('serialize', Str $file, Str :m(:$mode) = 'perl')
{
    use TXN;
    given $mode
    {
        when /:i perl/
        {
            say from-txn(:$file).perl;
        }
        when /:i json/
        {
            say from-txn(:$file, :json);
        }
        default
        {
            say "Sorry, invalid mode.\n";
            USAGE();
            exit 1;
        }
    }
}




# -----------------------------------------------------------------------------
# usage
# -----------------------------------------------------------------------------

sub USAGE()
{
    my Str $help-text = q:to/EOF/;
    Usage:
      mktxn [--pkgname=NAME]
            [--pkgver=VERSION]
            [--pkgrel=RELEASE]
            [--pkgdesc=DESCRIPTION]
            [--txndir=PATH]
            [--date-local-offset=OFFSET]
            [--template=TEMPLATE]
            FILE                            Make release build from file
      mktxn [--mode=MODE] serialize FILE    Serialize transaction journal

    optional arguments:
      -N, --pkgname=NAME
        the name of release build
      -V, --pkgver=VERSION
        the version number of release build
      -R, --pkgrel=RELEASE
        the release number of release build
      -D, --pkgdesc=DESCRIPTION
        the description of release build
      -I, --txndir=PATH
        the <include> directory (default: ~/.config/mktxn/txn)
      -L, --date-local-offset=OFFSET
        the local offset for dates without one (default: 0)
      -T, --template=TEMPLATE
        the location of the config template for release build
      -m, --mode=MODE
        the serialization format (json, perl)
    EOF
    say $help-text.trim;
}

# vim: ft=perl6 fdm=marker fdl=0
